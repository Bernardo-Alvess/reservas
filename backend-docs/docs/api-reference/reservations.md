---
sidebar_position: 2
---

# API de Reservas

Este documento detalha todos os endpoints relacionados ao m√≥dulo de reservas, incluindo cria√ß√£o, consulta, atualiza√ß√£o e confirma√ß√£o de reservas.

## üìã Vis√£o Geral

O m√≥dulo de reservas √© o cora√ß√£o do sistema, permitindo:
- ‚úÖ **Cria√ß√£o autom√°tica de reservas** com atribui√ß√£o de mesa
- üîç **Consulta de disponibilidade** em tempo real
- ‚úâÔ∏è **Sistema de confirma√ß√£o dupla** (cliente e restaurante)
- üìä **Relat√≥rios e estat√≠sticas** de reservas

## üéØ Base URL

```
/api/reserve
```

## üöÄ Endpoints

### 1. Criar Nova Reserva

**POST** `/api/reserve`

Cria uma nova reserva com atribui√ß√£o autom√°tica de mesa baseada na disponibilidade.

#### Headers
```http
Content-Type: application/json
Cookie: sessionToken=... (opcional para clientes)
```

#### Request Body

```json
{
  "restaurantId": "507f1f77bcf86cd799439011",
  "customerName": "Jo√£o Silva",
  "customerEmail": "joao@email.com",
  "customerPhone": "+5511999999999",
  "date": "2024-02-15",
  "time": "19:30",
  "numberOfPeople": 4,
  "specialRequests": "Mesa pr√≥xima √† janela, anivers√°rio"
}
```

#### Response (201 Created)

```json
{
  "data": {
    "id": "507f1f77bcf86cd799439022",
    "restaurantId": "507f1f77bcf86cd799439011",
    "tableId": "507f1f77bcf86cd799439033",
    "customerName": "Jo√£o Silva",
    "customerEmail": "joao@email.com",
    "customerPhone": "+5511999999999",
    "date": "2024-02-15T00:00:00.000Z",
    "time": "19:30",
    "numberOfPeople": 4,
    "specialRequests": "Mesa pr√≥xima √† janela, anivers√°rio",
    "status": "pending",
    "confirmation": {
      "clientConfirmed": false,
      "restaurantConfirmed": false
    },
    "table": {
      "id": "507f1f77bcf86cd799439033",
      "number": "12",
      "capacity": 6,
      "location": "janela"
    },
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  },
  "message": "Reserva criada com sucesso. Mesa atribu√≠da automaticamente."
}
```

#### Response (409 Conflict)

```json
{
  "error": {
    "code": "NO_TABLES_AVAILABLE",
    "message": "Nenhuma mesa dispon√≠vel para o hor√°rio solicitado",
    "details": {
      "date": "2024-02-15",
      "time": "19:30",
      "numberOfPeople": 4,
      "availableAlternatives": [
        {
          "time": "18:30",
          "availableTables": 3
        },
        {
          "time": "20:30",
          "availableTables": 2
        }
      ]
    }
  },
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 2. Listar Reservas

**GET** `/api/reserve`

Lista reservas com filtros opcionais e pagina√ß√£o.

#### Query Parameters

| Par√¢metro | Tipo | Descri√ß√£o | Padr√£o |
|-----------|------|-----------|--------|
| `page` | number | P√°gina atual | 1 |
| `limit` | number | Itens por p√°gina | 10 |
| `restaurantId` | string | Filtrar por restaurante | - |
| `status` | string | Filtrar por status | - |
| `date` | string | Filtrar por data (YYYY-MM-DD) | - |
| `customerEmail` | string | Filtrar por email do cliente | - |

#### Exemplo de Request

```bash
GET /api/reserve?restaurantId=507f1f77bcf86cd799439011&status=confirmed&page=1&limit=20
```

#### Response (200 OK)

```json
{
  "data": [
    {
      "id": "507f1f77bcf86cd799439022",
      "customerName": "Jo√£o Silva",
      "customerEmail": "joao@email.com",
      "date": "2024-02-15T00:00:00.000Z",
      "time": "19:30",
      "numberOfPeople": 4,
      "status": "confirmed",
      "table": {
        "number": "12",
        "capacity": 6
      },
      "restaurant": {
        "name": "Restaurante Exemplo"
      },
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
  ],
  "meta": {
    "total": 150,
    "page": 1,
    "limit": 20,
    "totalPages": 8
  }
}
```

### 3. Buscar Reserva por ID

**GET** `/api/reserve/{id}`

Busca uma reserva espec√≠fica pelo ID.

#### Response (200 OK)

```json
{
  "data": {
    "id": "507f1f77bcf86cd799439022",
    "restaurantId": "507f1f77bcf86cd799439011",
    "tableId": "507f1f77bcf86cd799439033",
    "customerName": "Jo√£o Silva",
    "customerEmail": "joao@email.com",
    "customerPhone": "+5511999999999",
    "date": "2024-02-15T00:00:00.000Z",
    "time": "19:30",
    "numberOfPeople": 4,
    "specialRequests": "Mesa pr√≥xima √† janela, anivers√°rio",
    "status": "confirmed",
    "confirmation": {
      "clientConfirmed": true,
      "restaurantConfirmed": true,
      "confirmedAt": "2024-01-15T11:00:00.000Z"
    },
    "table": {
      "id": "507f1f77bcf86cd799439033",
      "number": "12",
      "capacity": 6,
      "location": "janela"
    },
    "restaurant": {
      "id": "507f1f77bcf86cd799439011",
      "name": "Restaurante Exemplo",
      "phone": "+5511888888888"
    },
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T11:00:00.000Z"
  }
}
```

### 4. Confirmar Reserva

**PATCH** `/api/reserve/confirm/{type}/{id}`

Confirma uma reserva. Pode ser confirmada pelo cliente ou pelo restaurante.

#### Parameters

| Par√¢metro | Tipo | Descri√ß√£o |
|-----------|------|-----------|
| `type` | string | `client` ou `restaurant` |
| `id` | string | ID da reserva |

#### Headers
```http
Cookie: sessionToken=... (obrigat√≥rio)
```

#### Response (200 OK)

```json
{
  "data": {
    "id": "507f1f77bcf86cd799439022",
    "status": "confirmed",
    "confirmation": {
      "clientConfirmed": true,
      "restaurantConfirmed": true,
      "confirmedAt": "2024-01-15T11:00:00.000Z"
    },
    "updatedAt": "2024-01-15T11:00:00.000Z"
  },
  "message": "Reserva confirmada com sucesso"
}
```

### 5. Atualizar Reserva

**PUT** `/api/reserve/{id}`

Atualiza dados de uma reserva existente.

#### Headers
```http
Content-Type: application/json
Cookie: sessionToken=... (obrigat√≥rio)
```

#### Request Body

```json
{
  "customerName": "Jo√£o Silva Santos",
  "customerPhone": "+5511888888888",
  "numberOfPeople": 6,
  "specialRequests": "Mesa pr√≥xima √† janela, anivers√°rio - 6 pessoas",
  "notes": "Cliente ligou para alterar n√∫mero de pessoas"
}
```

#### Response (200 OK)

```json
{
  "data": {
    "id": "507f1f77bcf86cd799439022",
    "customerName": "Jo√£o Silva Santos",
    "customerPhone": "+5511888888888",
    "numberOfPeople": 6,
    "specialRequests": "Mesa pr√≥xima √† janela, anivers√°rio - 6 pessoas",
    "notes": "Cliente ligou para alterar n√∫mero de pessoas",
    "updatedAt": "2024-01-15T12:00:00.000Z"
  },
  "message": "Reserva atualizada com sucesso"
}
```

### 6. Cancelar Reserva

**DELETE** `/api/reserve/{id}`

Cancela uma reserva (soft delete).

#### Headers
```http
Cookie: sessionToken=... (obrigat√≥rio)
```

#### Response (200 OK)

```json
{
  "data": {
    "id": "507f1f77bcf86cd799439022",
    "status": "cancelled",
    "cancelledAt": "2024-01-15T13:00:00.000Z"
  },
  "message": "Reserva cancelada com sucesso"
}
```

### 7. Verificar Disponibilidade

**GET** `/api/reserve/availability/{restaurantId}`

Verifica hor√°rios dispon√≠veis para um restaurante em uma data espec√≠fica.

#### Query Parameters

| Par√¢metro | Tipo | Descri√ß√£o | Obrigat√≥rio |
|-----------|------|-----------|-------------|
| `date` | string | Data (YYYY-MM-DD) | ‚úÖ |
| `numberOfPeople` | number | N√∫mero de pessoas | ‚úÖ |

#### Exemplo de Request

```bash
GET /api/reserve/availability/507f1f77bcf86cd799439011?date=2024-02-15&numberOfPeople=4
```

#### Response (200 OK)

```json
{
  "data": {
    "date": "2024-02-15",
    "numberOfPeople": 4,
    "availableSlots": [
      {
        "time": "18:00",
        "availableTables": 3,
        "tables": [
          {
            "id": "507f1f77bcf86cd799439033",
            "number": "12",
            "capacity": 6,
            "location": "janela"
          },
          {
            "id": "507f1f77bcf86cd799439034",
            "number": "8",
            "capacity": 4,
            "location": "centro"
          }
        ]
      },
      {
        "time": "18:30",
        "availableTables": 2,
        "tables": [...]
      },
      {
        "time": "19:00",
        "availableTables": 1,
        "tables": [...]
      }
    ],
    "unavailableSlots": [
      {
        "time": "19:30",
        "reason": "Todas as mesas ocupadas"
      },
      {
        "time": "20:00",
        "reason": "Todas as mesas ocupadas"
      }
    ]
  }
}
```

### 8. Relat√≥rio de Reservas

**GET** `/api/reserve/reports/stats`

Gera relat√≥rios e estat√≠sticas de reservas.

#### Headers
```http
Cookie: sessionToken=... (obrigat√≥rio)
Authorization: Bearer ... (alternativo)
```

#### Query Parameters

| Par√¢metro | Tipo | Descri√ß√£o |
|-----------|------|-----------|
| `restaurantId` | string | ID do restaurante |
| `startDate` | string | Data inicial (YYYY-MM-DD) |
| `endDate` | string | Data final (YYYY-MM-DD) |
| `groupBy` | string | `day`, `week`, `month` |

#### Response (200 OK)

```json
{
  "data": {
    "period": {
      "startDate": "2024-01-01",
      "endDate": "2024-01-31"
    },
    "summary": {
      "totalReservations": 145,
      "confirmedReservations": 132,
      "cancelledReservations": 13,
      "totalGuests": 580,
      "averagePartySize": 4.2,
      "occupancyRate": 78.5
    },
    "dailyStats": [
      {
        "date": "2024-01-01",
        "reservations": 12,
        "confirmed": 11,
        "cancelled": 1,
        "guests": 48
      }
    ],
    "statusBreakdown": {
      "pending": 8,
      "confirmed": 132,
      "cancelled": 13,
      "completed": 120
    }
  }
}
```

## üîÑ Fluxo da Reserva

```mermaid
stateDiagram-v2
    [*] --> Criada
    Criada --> Pendente: Cria√ß√£o autom√°tica
    Pendente --> Confirmada: Confirma√ß√£o dupla
    Pendente --> Cancelada: Cancelamento
    Confirmada --> Conclu√≠da: Ap√≥s o hor√°rio
    Confirmada --> Cancelada: Cancelamento
    Cancelada --> [*]
    Conclu√≠da --> [*]
    
    note right of Pendente
        Cliente e restaurante
        precisam confirmar
    end note
    
    note right of Confirmada
        Mesa atribu√≠da e
        hor√°rio reservado
    end note
```

## üìä Status de Reserva

| Status | Descri√ß√£o | A√ß√µes Permitidas |
|--------|-----------|------------------|
| `pending` | Aguardando confirma√ß√£o | Confirmar, Cancelar, Editar |
| `confirmed` | Confirmada por ambas as partes | Cancelar, Concluir |
| `cancelled` | Cancelada | Visualizar apenas |
| `completed` | Conclu√≠da (ap√≥s o hor√°rio) | Visualizar apenas |
| `no-show` | Cliente n√£o compareceu | Visualizar apenas |

## üõ°Ô∏è Permiss√µes e Autentica√ß√£o

### Endpoints P√∫blicos
- ‚úÖ `GET /api/reserve/availability/{restaurantId}` - Verificar disponibilidade

### Endpoints Autenticados
- üîê `POST /api/reserve` - Criar reserva (opcional para clientes)
- üîê `GET /api/reserve` - Listar reservas (filtradas por usu√°rio)
- üîê `PATCH /api/reserve/confirm/{type}/{id}` - Confirmar reserva

### Endpoints Administrativos
- üëë `GET /api/reserve/reports/stats` - Relat√≥rios (restaurant_admin, company_admin)
- üëë `PUT /api/reserve/{id}` - Editar reserva (restaurant_admin)
- üëë `DELETE /api/reserve/{id}` - Cancelar reserva (restaurant_admin)

## ‚ö†Ô∏è Regras de Neg√≥cio

### Cria√ß√£o de Reserva

1. **Data v√°lida**: N√£o pode ser no passado
2. **Hor√°rio de funcionamento**: Deve estar dentro do hor√°rio do restaurante
3. **Capacidade**: N√∫mero de pessoas entre 1 e 20
4. **Disponibilidade**: Mesa dispon√≠vel no hor√°rio solicitado
5. **Anteced√™ncia m√≠nima**: 30 minutos antes do hor√°rio

### Confirma√ß√£o de Reserva

1. **Dupla confirma√ß√£o**: Cliente E restaurante devem confirmar
2. **Prazo**: Confirma√ß√£o deve ocorrer at√© 2 horas antes do hor√°rio
3. **Status**: Apenas reservas "pending" podem ser confirmadas

### Cancelamento

1. **Prazo**: At√© 1 hora antes do hor√°rio agendado
2. **Penalidade**: Cancelamentos de √∫ltima hora podem gerar penalidade
3. **Libera√ß√£o**: Mesa fica dispon√≠vel imediatamente ap√≥s cancelamento

## üöÄ Pr√≥ximos Passos

<!-- - [API de Restaurantes](./restaurants) -->
<!-- - [API de Mesas](./tables) -->
<!-- - [API de Usu√°rios](./users) -->

## üìö Links Relacionados

<!-- - [API de Restaurantes](./restaurants) -->
<!-- - [API de Mesas](./tables) -->
<!-- - [API de Usu√°rios](./users) -->

### Refer√™ncias Externas

- [üîê Sistema de Autentica√ß√£o](../authentication/overview)
- [üèóÔ∏è Arquitetura do Sistema](../architecture/module-structure) 